# Use like this: sudo vmdb2 nanopi-r1_bookworm_armhf_vmdb2.yaml --output=../images/nanopi-r1_bookworm_armhf.img --rootfs-tarball=../rootfs/bookworm_armhf_rootfs.tgz --verbose --log=../log_build/log_nanopi-r1_bookworm_armhf_`/bin/date +"%F-%Hh-%Mmin"`.txt

steps:

  # Create one file with 4G size. File name is set by "--output" shell
  # parameter option

  - mkimg: "{{ output }}"
    size:  4G

  # Create partition entry on new image file...

  - mklabel: msdos
    device:  "{{ output }}"

  # And then create one primary partition

  - mkpart: primary
    device: "{{ output }}"
    start:  16M
    end:    100%
    tag:    root

  # Create now one entry (into /dev/) in  the kernel with this new device

  - kpartx: "{{ output }}"

  # Format image with standard ext4 filesystem tools

  - mkfs: ext4
    partition: root

  # Mount image (via loop device) on temporary mount point

  - mount: root

  # Unpack a tarball of the root filesystem to the image, and set the
  # rootfs_unpacked condition to true. If the tarball doesnt exist,do
  # nothing and leave the rootfs_unpacked condition to false.

  - unpack-rootfs: root

  # Create one rootfs on image according architecture, site and wished
  # Debian release

  - debootstrap: bookworm
    mirror: http://ftp.de.debian.org/debian
    target: root
    arch:   armhf
    components:
    - main
    - contrib
    - non-free
    unless: rootfs_unpacked

  - apt: install
    packages:
      - initramfs-tools
    tag: root
    unless: rootfs_unpacked

  # Install default files definition for current Debian, so that
  # futur Debian commands "apt update" and "apt upgrade" will run

  - create-file: /etc/apt/sources.list
    contents: |+
        # current Debian release (V12)
        deb http://ftp.de.debian.org/debian bookworm main contrib non-free non-free-firmware
        # next Debian release (V13)
        deb http://ftp.de.debian.org/debian trixie   main contrib non-free non-free-firmware
        #
    unless: rootfs_unpacked

  # Install preferences on the target. On nanopir1 target, only recent
  # kernel (Debian trixie) has a correct native DTS/TDB, so that it is
  # possible to flash-kernel and DTS suite tools

  - create-file: /etc/apt/preferences.d/debian_preferences.pref
    contents: |+
       # file : /etc/apt/preferences.d/debian_preferences.pref
       # This file is build by jeanmarc.lacroi@free.fr from project :
       # 
       # define behaviour on current release
       Package: *
       Pin: release o=Debian,l=Debian,n=bookworm
       Pin-Priority: 500

       # define behaviour on next release
       Package: *
       Pin: release o=Debian,l=Debian,n=trixie
       Pin-Priority: 50

       # define behaviour on kernel, so that new DTS is supported
       Package: linux-image-rt-armmp
       Pin: release o=Debian,l=Debian,n=trixie
       Pin-Priority: 980

       # use this package for most recent firmware for internal wifi
       Package: firmware-brcm80211
       Pin: release o=Debian,l=Debian,n=trixie
       Pin-Priority: 980
    unless: rootfs_unpacked

  # Install flash-kernel packages using  apt,  which needs to  already
  # have been installed before creating /boot final directory

  - apt: install
    packages:
      - flash-kernel
    tag: root
    recommends: true
    unless: rootfs_unpacked

  # launch a shell into chroot and make following actions...

  - chroot: root
    shell: |
      # Update internal Debian apt data base

      apt-get update

      # Update local installed packages according current Debian apt reference

      apt-get --assume-yes upgrade

      mv /etc/kernel/postinst.d/initramfs-tools /etc/kernel/postinst.d/zz-flash-kernel /

      # Install the current generic linux kernel for all armhf architecture

      apt-get --assume-yes install linux-image-rt-armmp

      # python3 is needed to launch "Ansible" tools later

      apt-get --assume-yes install python3 python3-apt

      # openssh-server is needed to connect to target on Ethernet port

      apt-get --assume-yes install openssh-server openssh-sftp-server

      # psmisc package for very usefull tools: pstree (!) 

      apt-get --assume-yes install psmisc

      # bind9-host package for very usefull tools: dig and host

      apt-get --assume-yes install bind9-host

      # In order to support wifi in STA & AP mode, install dedicated firmwares

      apt-get --assume-yes install firmware-brcm80211 firmware-linux-free

      # In order to support wifi in STA mode, install user space tools

      apt-get --assume-yes install iw wireless-tools wireless-regdb wpasupplicant isc-dhcp-clien

      # In order to support usb tools such as "lsusb"

      apt-get --assume-yes install usbutils

      mv /initramfs-tools /zz-flash-kernel /etc/kernel/postinst.d/
    unless: rootfs_unpacked

  # When target will  boot later,  we must  be sure  to have  one  ssh
  # access on  root  account because at  this time,  only Unix root is
  # created.  Of course, sysadmin set correct DHCP/DNS/default gateway
  # infrastructure,    so that one IPV4   address   is assigned to the
  # target.  Because this is the  first connection, we change  default
  # Debian  "/etc/ssh/sshd_config" profile bahaviour.   With  this new
  # profile configuration, root access is enable on the target without
  # password. Please  update  ASAP  this file according   your private
  # security policy.

  - create-file: /etc/ssh/sshd_config
    contents: |+
       AllowUsers                          root
       AcceptEnv                           LANG
       AddressFamily                       inet
       AllowTcpForwarding                  no
       AuthorizedKeysFile                  %h/.ssh/authorized_keys
       Banner                              none
       ChallengeResponseAuthentication     no
       Ciphers                             aes256-ctr
       ClientAliveCountMax                 5
       ClientAliveInterval                 20
       Compression                         no
       DebianBanner                        yes
       GSSAPIAuthentication                no
       GSSAPIKeyExchange                   no
       GSSAPICleanupCredentials            no
       HostbasedAuthentication             no
       HostbasedUsesNameFromPacketOnly     no
       HostKey                             /etc/ssh/ssh_host_ed25519_key
       IgnoreRhosts                        yes
       IgnoreUserKnownHosts                no
       KerberosAuthentication              no
       KerberosOrLocalPasswd               no
       KerberosTicketCleanup               no
       Port                                22
       ListenAddress                       0.0.0.0
       LoginGraceTime                      30
       LogLevel                            INFO
       MACs                                hmac-sha2-512
       MaxAuthTries                        3
       MaxSessions                         1
       MaxStartups                         10:30:60
       PasswordAuthentication              yes
       PermitEmptyPasswords                yes
       PermitRootLogin                     yes
       PermitTTY                           yes
       PermitTunnel                        yes
       PermitUserEnvironment               yes
       PermitUserRC                        yes
       PidFile                             /var/run/sshd.pid
       PrintLastLog                        yes
       PrintMotd                           no
       PubkeyAcceptedKeyTypes              ssh-ed25519
       PubkeyAuthentication                yes
       StrictModes                         yes
       Subsystem                           sftp   /usr/lib/openssh/sftp-server
       SyslogFacility                      AUTH
       TCPKeepAlive                        yes
       UsePAM                              no
       UseDNS                              yes
       X11DisplayOffset                    10
       X11Forwarding                       yes
       X11UseLocalhost                     yes
       XAuthLocation                       /usr/bin/xauth
    unless: rootfs_unpacked

  # Create mandatory kernel modules (/etc/modules) loaded on startup

  - create-file: /etc/modules
    contents: |+
      # Install 8021q module, in order to manage VLAN truncking

      8021q

      # Install module kernel (brcmfmac) for internal Wifi, remember,
      # need Debian Package firmware-brcm80211

      brcmfmac debug=1

      # LAN port : install  Ethernet driver (Ethernet on USB) (10/100)
      # r8152

      r8152

    unless: rootfs_unpacked

  # Create one empty fstab entry (/etc/fstab file) on target. 

  - fstab: root
    unless: rootfs_unpacked

  # Create a tarball of  the image root filesystem.  File name of this
  # file is defined by command  line option "--rootfs-tarball". Please
  # note  that  after    this step,  previous    condition  defined by
  # "rootfs_unpacked" change

  #- cache-rootfs: root
  #  unless: rootfs_unpacked

  # Now, all  code is not shared with  "rootfs cache" and is dedicated
  # to target

  # Set default  hostname    of target.  Please   note  there  are  no
  # requirements for this value, it is  user defined. Good practice is
  # to use the same name than DTS

  - create-file: /etc/hostname
    contents: |+
      nanopir1

  # According    /usr/share/doc/flash-kernel/README.gz  documentation,
  # default data-base    for   all  supported   SBC  (located     into
  # /usr/share/flash-kernel/db/all.db) does  not yet support nanopi-r1
  # board.   As  a  result,  create     one entry  and  install   this
  # definition  into top dir located  into /etc/flashkernel/db so that
  # this file is parsed earlier when launching "flash-kernel" tool

  - create-file: /etc/flash-kernel/db
    contents: |+
      Machine: FriendlyElec NanoPi-R1
      Kernel-Flavors: armmp armmp-lpae
      Boot-Script-Path: /boot/boot.scr
      DTB-Id: sun8i-h3-nanopi-r1.dtb
      U-Boot-Script-Name: bootscr.sunxi
      Required-Packages: u-boot-tools

  # According    /usr/share/doc/flash-kernel/README.gz  documentation,
  # because  nanopi-r1  is not  yet supported,  then  skip the machine
  # auto-detection from /proc/cpuinfo and force a specific Machine

  - create-file: /etc/flash-kernel/machine
    contents: |+
      FriendlyElec NanoPi-R1

  - chroot: root
    shell: |

      # Add hostname to /etc/hosts for IPv4 & IPv6
      HOSTNAME=$(cat /etc/hostname)
      sed -i "2i127.0.0.2\t$HOSTNAME" /etc/hosts
      sed -i "4i::2\t\t$HOSTNAME" /etc/hosts

      sed -i "s@errors=remount-ro@noatime,nodiratime,errors=remount-ro@g" /etc/fstab

      sed -i "s@quiet@root=$(grep ^UUID /etc/fstab | cut -d \  -f 1) net.ifnames=0@g" /etc/default/flash-kernel

      # Back-up fsck
      mv /usr/share/initramfs-tools/hooks/fsck /usr/share/initramfs-tools/hooks/fsck.bak
      chmod -x /usr/share/initramfs-tools/hooks/fsck.bak

      # Fix fsck to read root fstype in fstab
      sed "s@\[.*\"\/\".*|| @@g" /usr/share/initramfs-tools/hooks/fsck.bak > /usr/share/initramfs-tools/hooks/fsck
      chmod +x /usr/share/initramfs-tools/hooks/fsck

      update-initramfs -c -k $(ls -l /vmlinuz | sed "s%^.*vmlinuz-\(.*\)$%\1%g")

      sed -i "s@root:\*:@root::@g" /etc/shadow

  # because nanopi-r1 u-boot is not available in Debian
  # package, get current package from Armbian project

  - root-fs: root
    shell: |
      curl -L -o $ROOT/u-boot.deb https://imola.armbian.com/apt/pool/main/l/linux-u-boot-nanopi-r1-current/linux-u-boot-current-nanopi-r1_21.02.2_armhf.deb

  # Install Armbian u-boot package in rootfs

  - chroot: root
    shell: |
      dpkg -i u-boot.deb
      rm u-boot.deb

  # Install directly u-boot on rootfs. Please note that in standard
  # Debian   package   "u-boot-sunxi",     target nanopir1   is    not
  # available. Look at command : dpkg -L u-boot-sunxi |grep -i nanopi

  - root-fs: root
    shell: |
      dd conv=fsync,notrunc if=$ROOT/usr/lib/linux-u-boot-current-nanopi-r1_21.02.2_armhf/u-boot-sunxi-with-spl.bin of={{ output }} bs=1024 seek=8

  - create-file: /etc/network/interfaces
    contents: |+
      # loopback interface 
      allow-auto lo
      iface      lo inet loopback

      # interface 1/3: WAN, eth0 (100 Mbit/sec), DHCP only on IPV4
      allow-auto eth0
      iface      etho inet dhcp
  
      # interface 2/3: LAN eth1 (1 Gbit/sec), DHCP only on IPV4
      allow-auto eth1
      #iface     eth1 inet dhcp
      iface      eth1 inet static
      address    192.168.254.99
      network    192.168.254.0
      broadcast  192.168.254.255
      netmask    255.255.255.0
      up         /usr/sbin/ip route add default via 192.168.254.253 dev eth1
      down       /usr/sbin/ip route add default dev eth1

      # interface 3/3: WLAN wlan0, wifi in STA mode
      allow-auto wlan0
      iface      wlan0 inet dhcp
      wpa-group       CCMP TKIP
      wpa-pairwise    CCMP TKIP
      wpa-proto       WPA RSN 
      wpa-key-mgmt    WPA-PSK
      wpa-auth-alg    OPEN
      wpa-debug-level 3   # either 1,2 or 3
      wpa-driver      wext,nl80211
      wpa-iface       wlan0
      wpa-ap-scan     1
      wpa-scan-ssid   1
      wpa-logfile     /var/log/wpa_supplicant.log
      wpa-psk         "12lapiteau;"
      wpa-ssid        "Pixel-3a-jm"
      wpa-ctrl_interface /var/run/wpa_supplicant

  - root-fs: root
    shell: |
      test -e vmdb2-ansible.yaml || ln -s vmdb2-ansible.yaml.example vmdb2-ansible.yaml
      mount -t proc proc $ROOT/proc

  - ansible: root
    playbook: vmdb2-ansible.yaml

  - root-fs: root
    shell: |
      # Restore fsck
      mv $ROOT/usr/share/initramfs-tools/hooks/fsck.bak $ROOT/usr/share/initramfs-tools/hooks/fsck
      chmod +x $ROOT/usr/share/initramfs-tools/hooks/fsck

      umount $ROOT/proc
      rm $ROOT/etc/flash-kernel/machine

  - create-file: /etc/resolv.conf
    contents: |

       # either set one DNS   server in canonical IPV4 format,  either
       # let it blank  (or in comment) so that  DHCP server can update
       # dynamically this file when receiving DHCP-LEASE

       nameserver  192.168.254.253

